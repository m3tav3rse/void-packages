# Template file for 'coreboot-utils'
pkgname=coreboot-utils
version=4.8.1
revision=1
only_for_archs="i686 i686-musl x86_64 x86_64-musl"
build_style=meta
wrksrc="coreboot-${version}"
build_wrksrc="util"
hostmakedepends="make"
makedepends="pciutils-devel zlib-devel"
depends="coreboot-utils-cbfstool coreboot-utils-cbmem \
coreboot-utils-ectool coreboot-utils-ifdtool coreboot-utils-inteltool \
coreboot-utils-intelmetool coreboot-utils-nvramtool coreboot-utils-superiotool"
short_desc="Coreboot firmware utilities"
maintainer="m3tav3rse <n6maa10816@tuta.io>"
license="GPL-2.0-only"
homepage="https://coreboot.org"
distfiles="https://coreboot.org/releases/coreboot-${version}.tar.xz>${pkgname}-\
${version}.tar.xz"
checksum=f0ddf4db0628c1fe1e8348c40084d9cbeb5771400c963fd419cda3995b69ad23

post_extract() {
	case "$XBPS_TARGET_MACHINE" in
		x86_64-musl)
			for p in ${FILESDIR}/*.patch; do
				patch -Np0 -i "$p"
			done
		;;
	esac
}

do_build() {

	for util in cbfstool cbmem ectool ifdtool inteltool intelmetool \
		nvramtool superiotool; do
		make ${makejobs} -C $util
	done
}

coreboot-utils-cbfstool_package() {
	short_desc+=" - cbfstool"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vbin cbfstool/cbfstool
	}
}

coreboot-utils-cbmem_package() {
	short_desc+=" - cbmem"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vbin cbmem/cbmem
	}
}

coreboot-utils-ectool_package() {
	short_desc+=" - ectool"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vbin ectool/ectool
	}
}

coreboot-utils-ifdtool_package() {
	short_desc+=" - ifdtool"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vbin ifdtool/ifdtool
	}
}

coreboot-utils-inteltool_package() {
	short_desc+=" - inteltool"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vbin inteltool/inteltool
		vman inteltool/inteltool.8
	}
}

coreboot-utils-intelmetool_package() {
	short_desc+=" - intelmetool"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vbin intelmetool/intelmetool
	}
}

coreboot-utils-nvramtool_package() {
	short_desc+=" - nvramtool"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vbin nvramtool/nvramtool
		vman nvramtool/cli/nvramtool.8
	}
}

coreboot-utils-superiotool_package() {
	short_desc+=" - superiotool"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vbin superiotool/superiotool
		vman superiotool/superiotool.8
	}

}

coreboot-utils-me_cleaner_package() {
	depends="python3"
	short_desc+=" - tool for partial deblobbing Intel ME/TXE firmware"
	license="GPL-3.0-or-later"
	pkg_install() {
		vbin me_cleaner/me_cleaner.py me_cleaner
		vman me_cleaner/man/me_cleaner.1
	}
}
